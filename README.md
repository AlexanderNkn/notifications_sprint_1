# Проектная работа 10 спринта
Задачи можно посмотреть в /tasks

## Ссылка на репозиторий с проектом:
https://github.com/AlexanderNkn/notifications_sprint_1

## Описание
Сервис нотификации оповещает пользователя о событиях посредством email рассылки. Возможно расширение для sms и push уведомлений. События могут быть как мгновенными, например приветственное письмо при регистрации нового пользователя, так и периодическими, например статистика в конце каждого месяца по просмотренным пользователем фильмам.

## Архитектурные решения
- описание диаграмм в формате plantUML представлено в docs/architecture/

### Работа в 10 спринте
![Архитектура сервисов нотификации](docs/architecture/notifications_architecture.png)

### Описание диаграммы
Сервисы по результатам своей работы отправляют события в общую шину событий. Например сервис scheduler может выставить событие, что пора сделать еженедельное напоминание пользователям о кинотеатре. Сервис auth может сообщить, что зарегистрировался новый пользователь. Менеджер через админ-панель сообщает, что вышел новый сериал. Любое событие каждый сервис не зависимо друг от друга шлет в общую шину событий (в данном случае в kafka).
Сервис нотификаций слушает соотвествующие топики и при наступлении события вызывает функцию-обработчик этого конкретного события. Функция обработчик сначала обращается в auth за данными пользователей, которым нужно выслать оповещение, затем в остальные сервисы за связанными данными. К примеру, чтобы подготовить ежемесячную статистику, нужно по user_id в сервисе ugc найти все просмотренные этим пользователем фильмы за последний месяц, а по полученным из ugc идентификаторам movie_id из сервиса movies-api выгрузить жанры фильмов. Тогда в статистике будет понятно, какие жанры предпочитал смотреть пользователь последний месяц.
В зависимости от таймзоны пользователя, может потребоваться отправить сообщение через некоторое время. В этом случае, идентификаторы пользователей, сгруппированные по таймзонам, помещаются в redis, а сервис нотификаций ставит в scheduler новый план - перезапустить определенную задачу через определенное время. Но на этот раз сервис нотификаций будет использовать только списки пользователей, соответствующие таймзоне задачи (по ключу запросит из redis)
Сообщения, готовые к отправке, сервис нотификаций выставляет в очередь rabbitmq и добавляет шаблон, который нужно использовать при рассылке. При необходимости срочные сообщения можно выкладывать в отдельную очередь и обрабатывать ее бОльшим количеством воркеров.
Воркер забирает сообщение из очереди, помещает данные в шаблон (используем Jinja2) и отправляет письмо. 
